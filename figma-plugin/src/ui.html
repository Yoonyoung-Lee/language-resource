<!-- figma-plugin/ui.html (핵심 부분) -->
<body>
  <div class="wrap">
    <div>
      <button id="btn-selection">선택 요소</button>
      <button id="btn-document">전체 검토</button>
    </div>

    <textarea id="ta-input" rows="4" placeholder="문구 입력"></textarea>
    <button id="btn-suggest">문구 수정 제안 받기</button>

    <pre id="out"></pre>
  </div>

  <script>
    // 개발용 API 엔드포인트
    const API_BASE_URL = "http://localhost:3000/api";

    const out = document.getElementById("out");
    const ta = document.getElementById("ta-input");

    // Code → UI 메시지 수신
    window.onmessage = (event) => {
      const msg = event.data?.pluginMessage;
      if (!msg) return;

      if (msg.type === "SELECTION") {
        ta.value = msg.text || "";
        out.textContent = "선택 텍스트를 불러왔어요.";
      }
      if (msg.type === "DOCUMENT_TEXTS") {
        out.textContent = "문서 텍스트 " + msg.texts.length + "개 수집 완료";
        // 여기서 /audit 호출 가능
        audit(msg.texts);
      }
    };

    // UI → Code 요청: 선택 텍스트 가져오기
    document.getElementById("btn-selection").addEventListener("click", () => {
      parent.postMessage({ pluginMessage: { type: "GET_SELECTION" } }, "*");
    });

    // UI → Code 요청: 문서 전체 텍스트
    document.getElementById("btn-document").addEventListener("click", () => {
      parent.postMessage({ pluginMessage: { type: "GET_DOCUMENT" } }, "*");
    });

    // 제안 받기
    document.getElementById("btn-suggest").addEventListener("click", async () => {
      const text = ta.value || "";
      if (!text.trim()) {
        out.textContent = "입력된 문구가 없어요.";
        return;
      }
      try {
        const res = await fetch(`${API_BASE_URL}/suggest`, {
          method: "POST",
          headers: { "Content-Type": "application/json", "x-secret": "devpass" },
          body: JSON.stringify({ text, locale: "ko-KR" })
        });
        const data = await res.json();
        out.textContent = `제안: ${data.suggestion}\n사유: ${data.rationale || ""}`;

        // 적용 버튼 UI를 만들었다면, 적용 시:
        // parent.postMessage({ pluginMessage: { type: "APPLY_SUGGESTION", text: data.suggestion }}, "*");
      } catch (e) {
        out.textContent = "제안 호출 실패: " + e;
      }
    });

    async function audit(texts) {
      try {
        const res = await fetch(`${API_BASE_URL}/audit`, {
          method: "POST",
          headers: { "Content-Type": "application/json", "x-secret": "devpass" },
          body: JSON.stringify({ texts, locale: "ko-KR" })
        });
        const data = await res.json();
        out.textContent = `검토 완료: matched ${data.stats.matched}, missing ${data.stats.missing}`;
      } catch (e) {
        out.textContent = "검토 호출 실패: " + e;
        
      }
    }
  </script>
</body>